<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>Details</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        :root {
            --bg: #fff;
            --text: #333;
            --brand: #ff4757;
        }

        body.dark {
            --bg: #1a1a1a;
            --text: #f0f0f0;
            --brand: #ff6b81;
        }

        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: 30px auto;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }

        .cmt-box {
            margin-top: 50px;
            border-top: 2px solid var(--brand);
            padding-top: 20px;
        }

        .cmt-item {
            background: rgba(128, 128, 128, 0.1);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        input {
            padding: 10px;
            border-radius: 8px;
            border: 1px solid #ddd;
            margin-right: 5px;
        }

        .btn-send {
            background: var(--brand);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <h1 id="t"></h1>
    <div id="info"
        style="color:#888; font-size:0.9em; margin-bottom:20px; border-bottom:1px solid #eee; padding-bottom:10px;">
    </div>
    <div id="c" style="white-space: pre-wrap; font-size: 1.1em;">åŠ è½½ä¸­...</div>

    <div class="cmt-box">
        <h3 data-zh="ğŸ’¬ è¯„è®ºåŒº" data-en="ğŸ’¬ Comments">ğŸ’¬ è¯„è®ºåŒº</h3>
        <div id="cmt-list"></div>
        <div style="margin-top:20px; display:flex;">
            <input type="text" id="cN" data-zh-ph="æ˜µç§°" data-en-ph="Name" style="width:80px;">
            <input type="text" id="cC" data-zh-ph="ç¥è¯„ç”±æ­¤è¯ç”Ÿ..." data-en-ph="Write a comment..." style="flex:1">
            <button onclick="addCmt()" class="btn-send" data-zh="å‘é€" data-en="Send">å‘é€</button>
        </div>
    </div>
    <br><a href="othersPost.html" style="color:var(--brand); text-decoration:none;" data-zh="â¬…ï¸ è¿”å›å¹¿åœº"
        data-en="â¬…ï¸ Back">â¬…ï¸ è¿”å›å¹¿åœº</a>

    <script>
    // 1. ç”µæºç½®é¡¶ï¼Œç»Ÿä¸€ä½¿ç”¨ 4ANKO
    AV.init({
        appId: "M7KeNAw2myFEaXvSEJPbtPpA-MdYXbMMI",
        appKey: "O9DYEDbkHLvecHlEact4ANKO",
        serverURL: "https://m7kenaw2.api.lncldglobal.com"
    });

    const id = new URLSearchParams(window.location.search).get('id');
    const isAdmin = sessionStorage.getItem('isAdmin') === 'true';

    async function load() {
        try {
            const query = new AV.Query('Post');
            const p = await query.get(id); // è·å–å¸–å­å†…å®¹
            document.getElementById('t').innerText = p.get('title');
            document.getElementById('info').innerText = `ğŸ‘¤ ${p.get('nickname')} | ğŸ“… ${p.createdAt.toLocaleString()}`;
            document.getElementById('c').innerText = p.get('content');
            
            // åŠ è½½å¸–å­æˆåŠŸåï¼Œå†åŠ è½½è¯„è®º
            await loadCmts();
        } catch (err) {
            // ğŸ”¥ å¦‚æœå¤±è´¥ï¼ŒæŠŠé”™è¯¯æ˜¾ç¤ºåœ¨åŸæœ¬â€œåŠ è½½ä¸­â€çš„ä½ç½®
            document.getElementById('c').innerHTML = `<p style="color:red;">âŒ åŠ è½½å¤±è´¥ï¼š${err.message}</p>`;
        }
    }

    async function loadCmts() {
        try {
            const query = new AV.Query('Comment');
            query.equalTo('postId', id);
            query.ascending('createdAt');
            const cmts = await query.find();
            
            document.getElementById('cmt-list').innerHTML = cmts.map(c => `
                <div class="cmt-item" style="display:flex; justify-content:space-between; align-items:center;">
                    <div><b>${c.get('nickname')}:</b> ${c.get('content')}</div>
                    ${isAdmin ? `<button onclick="delCmt('${c.id}')" style="color:red; background:none; border:none; cursor:pointer; font-size:0.8em;">åˆ é™¤</button>` : ''}
                </div>`).join('') || '<p style="color:#888">æš‚æ— è¯„è®º</p>';
        } catch (err) {
            document.getElementById('cmt-list').innerHTML = `<p style="color:red;">è¯„è®ºåŒºåŠ è½½å¤±è´¥ï¼š${err.message}</p>`;
        }
    }

    // ... å…¶ä»– addCmt å’Œ delCmt å‡½æ•°ä¿æŒä¸å˜ ...
    if(localStorage.getItem('theme')==='dark') document.body.className='dark';
    load();
</script>
</body>

</html>