<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8"><title>åæ§½å¹¿åœº Plaza</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        :root { --bg: #fffdf5; --text: #333; --card: #fff; --brand: #ff4757; }
        body.dark { --bg: #1a1a1a; --text: #f0f0f0; --card: #2d2d2d; --brand: #ff6b81; }
        body { font-family: sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); transition: 0.5s; }
        .card { background: var(--card); margin: 15px 0; padding: 15px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); display: flex; justify-content: space-between; align-items: center; }
        .info { font-size: 0.8em; color: #888; margin-top: 5px; }
        .del-btn { color: #ff4d4d; font-size: 0.9em; cursor: pointer; border: none; background: none; margin-left: 10px; font-weight: bold; }
        .hot-btn { background: linear-gradient(45deg, var(--brand), #ffa502); color: white; border: none; padding: 10px 20px; border-radius: 20px; cursor: pointer; font-weight: bold; }
    </style>
</head>
<body>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 data-zh="ğŸ‘€ åæ§½å¹¿åœº" data-en="ğŸ‘€ Rant Plaza">ğŸ‘€ åæ§½å¹¿åœº</h1>
        <button class="hot-btn" onclick="toggleHot()" id="hBtn" data-zh="ğŸ”¥ çƒ­æœ" data-en="ğŸ”¥ Top 3">ğŸ”¥ çƒ­æœ</button>
    </div>
    <div id="list" style="min-height: 300px;">åŠ è½½ä¸­...</div>
    <a href="index.html" style="color: var(--brand); text-decoration: none; font-weight: bold;" data-zh="ğŸ  è¿”å›é¦–é¡µ" data-en="ğŸ  Back Home">ğŸ  è¿”å›é¦–é¡µ</a>

    <script>
    // 1. ç»Ÿä¸€ç”µæºï¼Œå¿…é¡»åœ¨æœ€å‰é¢
    AV.init({
        appId: "M7KeNAw2myFEaXvSEJPbtPpA-MdYXbMMI",
        appKey: "O9DYEDbkHLvecHlEact4ANKO", // ä½¿ç”¨ä½ ç”µè„‘æˆåŠŸçš„ 4ANKO
        serverURL: "https://m7kenaw2.api.lncldglobal.com"
    });

    let isHot = false;
    // è·å–æˆ‘å‘å¸ƒçš„å¸–å­ ID
    const myAuthored = JSON.parse(localStorage.getItem('my_authored_ids')) || [];

    async function render() {
        const list = document.getElementById('list');
        try {
            const query = new AV.Query('Post');
            if(isHot) query.descending('likes').limit(3);
            else query.descending('createdAt');

            const posts = await query.find();
            list.innerHTML = posts.map(p => {
                const d = p.attributes;
                const time = p.createdAt.toLocaleString();
                const canDelete = myAuthored.includes(p.id);
                return `
                    <div class="card">
                        <div style="flex:1">
                            <a href="content.html?id=${p.id}" style="text-decoration:none; color:inherit; font-size:1.1em;"><b>${d.title}</b></a>
                            <div class="info">ğŸ‘¤ ${d.nickname} | ğŸ“… ${time} 
                                ${canDelete ? `<button class="del-btn" onclick="deletePost('${p.id}')">åˆ é™¤</button>` : ''}
                            </div>
                        </div>
                        <button id="like-btn-${p.id}" onclick="like('${p.id}')" style="background:none; border:1px solid #ddd; padding:8px; border-radius:8px; cursor:pointer; color:inherit;">ğŸ‘ ${d.likes || 0}</button>
                    </div>`;
            }).join('') || "ç›®å‰è¿˜æ²¡æœ‰åæ§½ï¼Œå¿«å»æŠ¢æ²™å‘ï¼";
        } catch (err) {
            list.innerHTML = "<p style='color:red;'>æ•°æ®åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é¡µé¢ã€‚</p>";
            console.error(err);
        }
    }

    // ğŸ”¥ å‡çº§ç‰ˆç‚¹èµé€»è¾‘ï¼šé˜²æ­¢ä¸€ä¸ªäººç‹‚ç‚¹
    async function like(id) {
        // å…ˆæ£€æŸ¥æœ¬åœ°è®°å½•ï¼Œçœ‹æ˜¯å¦ç‚¹è¿‡
        let likedIds = JSON.parse(localStorage.getItem('my_liked_ids')) || [];
        
        if (likedIds.includes(id)) {
            alert("ä½ å·²ç»ç»™è¿‡è¿™æ¡åæ§½èƒ½é‡äº†ï¼Œæ¯äººåªèƒ½ç‚¹èµä¸€æ¬¡å“¦ï¼");
            return;
        }

        try {
            const post = AV.Object.createWithoutData('Post', id);
            post.increment('likes', 1);
            await post.save();
            
            // ç‚¹èµæˆåŠŸåï¼ŒæŠŠ ID å­˜å…¥æœ¬åœ°â€œå·²èµåå•â€
            likedIds.push(id);
            localStorage.setItem('my_liked_ids', JSON.stringify(likedIds));
            
            // é‡æ–°åˆ·æ–°åˆ—è¡¨æ˜¾ç¤ºæœ€æ–°æ•°å­—
            render();
        } catch (err) {
            alert("ç‚¹èµå¤±è´¥ï¼š" + err.message);
        }
    }

    async function deletePost(id) {
        if(confirm('ç¡®å®šåˆ é™¤ä½ çš„è¿™æ¡å¸–å­å—ï¼Ÿ')) {
            const post = AV.Object.createWithoutData('Post', id);
            await post.destroy();
            render();
        }
    }

    function toggleHot() { isHot = !isHot; render(); }
    if(localStorage.getItem('theme')==='dark') document.body.className='dark';
    render();
</script>
</body>
</html>