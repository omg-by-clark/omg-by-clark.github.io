<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <title>åæ§½å¹¿åœº Plaza</title>
    <script src="https://cdn.jsdelivr.net/npm/leancloud-storage@4.12.0/dist/av-min.js"></script>
    <style>
        :root {
            --bg: #fffdf5;
            --text: #333;
            --card: #fff;
            --brand: #ff4757;
        }

        body.dark {
            --bg: #1a1a1a;
            --text: #f0f0f0;
            --card: #2d2d2d;
            --brand: #ff6b81;
        }

        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            background: var(--bg);
            color: var(--text);
            transition: 0.5s;
        }

        .card {
            background: var(--card);
            margin: 15px 0;
            padding: 15px;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .info {
            font-size: 0.8em;
            color: #888;
            margin-top: 5px;
        }

        .del-btn {
            color: #ff4d4d;
            font-size: 0.9em;
            cursor: pointer;
            border: none;
            background: none;
            margin-left: 10px;
            font-weight: bold;
        }

        .hot-btn {
            background: linear-gradient(45deg, var(--brand), #ffa502);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
        }
    </style>
</head>

<body>
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h1 data-zh="ğŸ‘€ åæ§½å¹¿åœº" data-en="ğŸ‘€ Rant Plaza">ğŸ‘€ åæ§½å¹¿åœº</h1>
        <button class="hot-btn" onclick="toggleHot()" id="hBtn" data-zh="ğŸ”¥ çƒ­æœ" data-en="ğŸ”¥ Top 3">ğŸ”¥ çƒ­æœ</button>
    </div>
    <div id="list" style="min-height: 300px;">åŠ è½½ä¸­...</div>
    <a href="index.html" style="color: var(--brand); text-decoration: none; font-weight: bold;" data-zh="ğŸ  è¿”å›é¦–é¡µ"
        data-en="ğŸ  Back Home">ğŸ  è¿”å›é¦–é¡µ</a>

    <script>
        // 1. ç»Ÿä¸€ç”µæºæ’å¤´
        AV.init({
            appId: "M7KeNAw2myFEaXvSEJPbtPpA-MdYXbMMI",
            appKey: "O9DYEDbkHLvecHlEact4ANKO",
            serverURL: "https://m7kenaw2.api.lncldglobal.com"
        });

        let isHot = false;
        const myAuthored = JSON.parse(localStorage.getItem('my_authored_ids')) || [];

        async function render() {
            const list = document.getElementById('list');
            // è·å–æœ¬åœ°â€œå·²ç‚¹èµâ€çš„åå•
            const myLiked = JSON.parse(localStorage.getItem('my_liked_ids')) || [];

            try {
                const query = new AV.Query('Post');
                if (isHot) query.descending('likes').limit(3);
                else query.descending('createdAt');

                const posts = await query.find();
                list.innerHTML = posts.map(p => {
                    const d = p.attributes;
                    const time = p.createdAt.toLocaleString();
                    const canDelete = myAuthored.includes(p.id);
                    // å…³é”®ç‚¹ï¼šæ£€æŸ¥æœ¬åœ°åå•ï¼Œå¦‚æœåœ¨é‡Œé¢ï¼Œå°±ç»™æŒ‰é’®åŠ ä¸ªâ€œlikedâ€æ ·å¼
                    const isLiked = myLiked.includes(p.id);
                    const btnStyle = isLiked ? 'background:#333; color:white;' : 'background:none; color:inherit;';

                    return `
                    <div class="card">
                        <div style="flex:1">
                            <a href="content.html?id=${p.id}" style="text-decoration:none; color:inherit;"><b>${d.title}</b></a>
                            <div class="info">ğŸ‘¤ ${d.nickname} | ğŸ“… ${time} 
                                ${canDelete ? `<button class="del-btn" onclick="deletePost('${p.id}')">åˆ é™¤</button>` : ''}
                            </div>
                        </div>
                        <button onclick="toggleLike('${p.id}')" style="${btnStyle} border:1px solid #ddd; padding:8px; border-radius:8px; cursor:pointer;">ğŸ‘ ${d.likes || 0}</button>
                    </div>`;
                }).join('') || "ç›®å‰è¿˜æ²¡æœ‰åæ§½";
            } catch (err) { console.error(err); }
        }

        // ğŸ”¥ å‡çº§ç‰ˆï¼šå¼€å…³å¼ç‚¹èµ
        async function toggleLike(id) {
            let likedIds = JSON.parse(localStorage.getItem('my_liked_ids')) || [];
            const index = likedIds.indexOf(id);
            const post = AV.Object.createWithoutData('Post', id);

            if (index === -1) {
                // è¿˜æ²¡ç‚¹è¿‡èµï¼šå˜æ·±è‰²ï¼Œèµ+1
                post.increment('likes', 1);
                likedIds.push(id);
            } else {
                // å·²ç»ç‚¹è¿‡äº†ï¼šå˜å›æµ…è‰²ï¼Œèµ-1
                post.increment('likes', -1);
                likedIds.splice(index, 1);
            }

            await post.save();
            localStorage.setItem('my_liked_ids', JSON.stringify(likedIds));
            render(); // åˆ·æ–°ç•Œé¢
        }

        async function deletePost(id) {
            if (confirm('ç¡®å®šåˆ é™¤ï¼Ÿ')) { await AV.Object.createWithoutData('Post', id).destroy(); render(); }
        }
        function toggleHot() { isHot = !isHot; render(); }
        render();
    </script>
</body>

</html>